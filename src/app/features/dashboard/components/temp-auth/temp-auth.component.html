<div class="temp-auth-page">
  <div class="page-header">
    <h1>
      🔐 کلاینت آزمایشی WebAuthn
      <span>امکان تست تمامی سرویس‌های /api/webauthn/* در محیط مرورگر</span>
    </h1>
    <p>
      از این صفحه برای ثبت، احراز هویت و مدیریت دستگاه‌های WebAuthn استفاده کنید. پیکربندی درخواست‌ها را مطابق با محیط
      اجرایی خود تنظیم نموده و سپس عملیات مورد نظر را آغاز کنید.
    </p>
  </div>

  <div nz-row [nzGutter]="[16, 16]">
    <div nz-col [nzSpan]="24" [nzLg]="14">
      <nz-card nzTitle="پیکربندی درخواست" class="config-card">
        <div class="config-grid">
          <label class="form-field">
            <span class="label-text">آدرس پایه API</span>
            <input nz-input type="url" [(ngModel)]="apiBase" placeholder="http://localhost:8001/api" />
          </label>

          <label class="form-field full-width">
            <span class="label-text">هدر احراز هویت</span>
            <textarea
              nz-input
              rows="3"
              [(ngModel)]="authToken"
              placeholder="Bearer &lt;jwt&gt;"
            ></textarea>
          </label>
        </div>

        <div class="action-row">
          <button nz-button nzType="primary" (click)="startRegistration()" [nzLoading]="loading.register">
            شروع ثبت‌نام
          </button>
          <button nz-button nzType="default" (click)="startAuthentication()" [nzLoading]="loading.authenticate">
            شروع احراز هویت
          </button>
          <button nz-button nzType="default" nzGhost (click)="listDevices()" [nzLoading]="loading.list">
            به‌روزرسانی دستگاه‌ها
          </button>
          <button nz-button nzType="default" nzGhost (click)="getMe()" [nzLoading]="loading.getMe">
            دریافت اطلاعات کاربر
          </button>
        </div>
      </nz-card>
    </div>

    <div nz-col [nzSpan]="24" [nzLg]="10" class="side-column">
      <nz-card nzTitle="حذف دستگاه" class="delete-card">
        <p class="card-helper">شناسه Credential را از لیست دستگاه‌ها یا پاسخ سرویس دریافت کرده و در این قسمت وارد کنید.</p>
        <div class="delete-grid">
          <input
            nz-input
            [(ngModel)]="credentialId"
            placeholder="شناسه Credential"
            aria-label="شناسه Credential"
          />
          <button
            nz-button
            nzType="default"
            nzDanger
            (click)="deleteDevice()"
            [nzLoading]="loading.delete"
          >
            حذف دستگاه
          </button>
        </div>
      </nz-card>

      <nz-card nzTitle="دستگاه‌های ثبت‌شده" class="devices-card" [nzLoading]="loading.list">
        <ng-container *ngIf="devices.length; else emptyDevices">
          <div class="device-card" *ngFor="let device of devices">
            <div class="device-header">
              <h3>{{ device.device_name || 'بدون نام' }}</h3>
              <nz-tag nzColor="blue">{{ device.sign_count }} بار استفاده</nz-tag>
            </div>
            <dl>
              <div>
                <dt>Credential ID</dt>
                <dd>{{ device.credential_id }}</dd>
              </div>
              <div>
                <dt>تاریخ ایجاد</dt>
                <dd>{{ device.created_at || '—' }}</dd>
              </div>
              <div>
                <dt>آخرین استفاده</dt>
                <dd>{{ device.last_used || '—' }}</dd>
              </div>
            </dl>
          </div>
        </ng-container>
        <ng-template #emptyDevices>
          <p class="empty-state">تا کنون دستگاهی ثبت نشده است.</p>
        </ng-template>
      </nz-card>
    </div>
  </div>

  <nz-card nzTitle="گزارش‌ها" class="log-card">
    <div class="log-toolbar">
      <button nz-button nzType="default" nzGhost (click)="clearLog()">پاک‌سازی گزارش‌ها</button>
    </div>
    <div class="log-container" #logContainer>
      <ng-container *ngIf="logs.length; else emptyLogs">
        <div class="log-entry" *ngFor="let entry of logs" [ngClass]="entry.level">
          <div class="log-entry__header">
            <span class="timestamp">{{ entry.timestamp }}</span>
            <nz-tag [nzColor]="logColor(entry.level)">{{ entry.level | uppercase }}</nz-tag>
          </div>
          <p class="message">{{ entry.message }}</p>
          <pre class="detail" *ngIf="entry.detail">{{ entry.detail }}</pre>
        </div>
      </ng-container>
      <ng-template #emptyLogs>
        <p class="empty-state">هنوز گزارشی ثبت نشده است.</p>
      </ng-template>
    </div>
  </nz-card>
</div>
