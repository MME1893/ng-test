<div class="temp-auth-page">
  <p class="status-message">{{ statusMessage }}</p>

  <nz-card class="auth-card">
    <ng-container *ngIf="cardStep === 'credentials'; else deviceStep">
      <h2 class="card-title">{{ authMode === 'signIn' ? 'ورود به حساب' : 'ثبت‌نام کاربر جدید' }}</h2>
      <p class="card-subtitle">
        {{ authMode === 'signIn' ? 'برای ورود، نام کاربری و رمز عبور خود را وارد کنید.' : 'برای ساخت حساب جدید، اطلاعات زیر را تکمیل کنید.' }}
      </p>

      <ng-container *ngIf="authMode === 'signIn'; else signUpFormTpl">
        <form class="credential-form" (ngSubmit)="submitSignIn()">
          <label class="form-field">
            <span>نام کاربری</span>
            <input nz-input name="signin-username" [(ngModel)]="signInForm.username" required />
          </label>

          <label class="form-field">
            <span>رمز عبور</span>
            <input nz-input type="password" name="signin-password" [(ngModel)]="signInForm.password" required />
          </label>

          <button nz-button nzType="primary" type="submit" [nzLoading]="loading.signIn">ورود</button>
        </form>
      </ng-container>

      <ng-template #signUpFormTpl>
        <form class="credential-form" (ngSubmit)="submitSignUp()">
          <label class="form-field">
            <span>نام کاربری</span>
            <input nz-input name="signup-username" [(ngModel)]="signUpForm.username" required />
          </label>

          <label class="form-field">
            <span>ایمیل</span>
            <input nz-input type="email" name="signup-email" [(ngModel)]="signUpForm.email" required />
          </label>

          <label class="form-field">
            <span>رمز عبور</span>
            <input nz-input type="password" name="signup-password" [(ngModel)]="signUpForm.password" required />
          </label>

          <button nz-button nzType="primary" type="submit" [nzLoading]="loading.signUp">ثبت‌نام</button>
        </form>
      </ng-template>

      <div class="switch-auth">
        <button nz-button nzType="link" type="button" (click)="authMode === 'signIn' ? switchToSignUp() : switchToSignIn()">
          {{ authMode === 'signIn' ? 'حسابی ندارید؟ ثبت‌نام کنید.' : 'حساب دارید؟ وارد شوید.' }}
        </button>
      </div>
    </ng-container>

    <ng-template #deviceStep>
      <h2 class="card-title">احراز هویت دستگاه</h2>

      <ng-container *ngIf="fullyAuthenticated; else pendingDevice">
        <p class="success-message">احراز هویت کاربر و دستگاه با موفقیت تکمیل شد.</p>
      </ng-container>

      <ng-template #pendingDevice>
        <p class="card-subtitle">{{ nextStepDescription }}</p>

        <div class="device-section" *ngIf="requiresRegistration">
          <p>برای تکمیل ورود، دستگاه خود را ثبت کنید.</p>
          <input
            nz-input
            placeholder="نام دستگاه (اختیاری)"
            [(ngModel)]="deviceName"
            [ngModelOptions]="{ standalone: true }"
          />
          <button nz-button nzType="primary" (click)="registerDevice()" [nzLoading]="loading.register">
            ثبت دستگاه
          </button>
        </div>

        <div class="device-section" *ngIf="requiresAuthentication">
          <p>برای ادامه، از دستگاه ثبت شده خود جهت احراز هویت استفاده کنید.</p>
          <button nz-button nzType="primary" (click)="authenticateDevice()" [nzLoading]="loading.authenticate">
            شروع احراز هویت دستگاه
          </button>
        </div>

        <div class="refresh-row">
          <button nz-button nzType="default" (click)="refreshSession()" [nzLoading]="loading.session">
            به‌روزرسانی وضعیت
          </button>
        </div>
      </ng-template>
    </ng-template>
  </nz-card>
</div>
